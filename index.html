<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>å°ç£è¡Œæ”¿å€ GIS</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="js/jquery-3.7.1.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="css/leaflet.css" />
    <script src="js/leaflet.js"></script>

    <style>
        body {
            margin: 0;
        }

        #map {
            height: 100vh;
        }

        .sidebar {
            height: 100vh;
            background: #f9fafb;
        }

        .info-box {
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row">

            <!-- å·¦å´ -->
            <div class="col-3 sidebar p-3 border-end">

                <h5 class="mb-3">è¡Œæ”¿å€é¸æ“‡</h5>

                <div class="mb-3">
                    <label class="form-label">ç¸£å¸‚</label>
                    <select id="citySelect" class="form-select"></select>
                </div>

                <div class="mb-3">
                    <label class="form-label">é„‰é®å€</label>
                    <select id="districtSelect" class="form-select"></select>
                </div>

                <button id="clearBtn" class="btn btn-outline-secondary w-100 mb-3">
                    æ¸…é™¤é¸å–
                </button>

                <!-- è³‡è¨Šå¡ -->
                <div id="infoBox" class="info-box d-none">
                    <h6 id="infoTitle"></h6>
                    <ul class="list-unstyled small mb-0">
                        <li>ğŸ‘¥ äººå£ï¼š<span id="pop"></span></li>
                        <li>ğŸ  å¹³å‡æˆ¿åƒ¹ï¼š<span id="price"></span></li>
                        <li>ğŸ“Š å¯†åº¦ï¼š<span id="density"></span></li>
                    </ul>
                </div>

            </div>

            <!-- åœ°åœ– -->
            <div class="col-9 p-0">
                <div id="map"></div>
            </div>

        </div>
    </div>

    <script>
        let map, geoLayer;
        let taiwanData = {};
        let selectedLayer = null;

        /* ç¯„ä¾‹çµ±è¨ˆè³‡æ–™ï¼ˆå¯æ›æˆçœŸå¯¦ä¾†æºï¼‰ */
        const stats = {
            "è‡ºåŒ—å¸‚ä¸­æ­£å€": { pop: 158000, price: "95 è¬ / åª", density: "23,000 /kmÂ²" },
            "è‡ºåŒ—å¸‚å¤§åŒå€": { pop: 129000, price: "85 è¬ / åª", density: "25,000 /kmÂ²" },
            "è‡ºåŒ—å¸‚ä¸­å±±å€": { pop: 230000, price: "110 è¬ / åª", density: "19,000 /kmÂ²" }
        };

        /* æ¨£å¼ */
        const baseStyle = {
            color: "#999",          // é‚Šæ¡†é¡è‰²
            weight: 1,              // é‚Šæ¡†å¯¬åº¦
            fillOpacity: 0.5,       // å¡«å……é€æ˜åº¦
            fillColor: "#333"    // å¡«å……é¡è‰²ç‚ºç°è‰²
        };

        const activeStyle = {
            color: "#999",          // é‚Šæ¡†é¡è‰²
            weight: 3,              // é‚Šæ¡†å¯¬åº¦
            fillOpacity: 0,         // å¡«å……é€æ˜åº¦è¨­ç‚º 0ï¼Œä½¿é¸ä¸­çš„å€åŸŸç„¡å¡«å……è‰²
        };

        /* åˆå§‹åŒ–åœ°åœ– */
        map = L.map("map").setView([23.7, 121], 8);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        /* è¼‰å…¥è¡Œæ”¿å€ GeoJSON */
        $.getJSON("js/json/twTown1982.geo.json", geo => {
            geoLayer = L.geoJSON(geo, {
                style: baseStyle,  // é è¨­æ¨£å¼ç‚ºç°è‰²å¡«å……
                onEachFeature: (feature, layer) => {
                    layer.on("click", () => {
                        // é»æ“Šå€åŸŸæ™‚åˆ‡æ›æ¨£å¼
                        selectArea(
                            feature.properties.COUNTYNAME,
                            feature.properties.TOWNNAME,
                            layer
                        );

                        // é»æ“Šå¾Œï¼Œå°‡è©²å€åŸŸæ¨£å¼åˆ‡æ›ç‚º activeStyle
                        layer.setStyle(activeStyle);

                        // åœ¨é¸ä¸­çš„å€åŸŸï¼Œå†æ¬¡é»æ“Šå‰‡æ¢å¾©ç‚ºé è¨­æ¨£å¼
                        layer.on("dblclick", () => {
                            layer.setStyle(baseStyle);
                        });
                    });
                }
            }).addTo(map);

            // è§£æ GeoJSON è³‡æ–™ä¸¦å¡«å……é¸å–®
            let cities = {};
            let cityCenters = {}; // å­˜å„²ç¸£å¸‚ä¸­å¿ƒç·¯åº¦
            let districtCenters = {}; // å­˜å„²é„‰é®å€ä¸­å¿ƒç·¯åº¦

            geo.features.forEach(feature => {
                let city = feature.properties.COUNTYNAME;
                let district = feature.properties.TOWNNAME;

                if (!cities[city]) cities[city] = [];
                if (!cities[city].includes(district)) {
                    cities[city].push(district);

                    // è¨ˆç®—ä¸¦å­˜å„²ä¸­å¿ƒé»
                    let bounds = L.geoJSON(feature).getBounds();
                    let center = bounds.getCenter();

                    // å­˜å„²ç¸£å¸‚ä¸­å¿ƒé»ï¼ˆå–å¹³å‡ç·¯åº¦ï¼‰
                    if (!cityCenters[city]) {
                        cityCenters[city] = { lat: 0, count: 0 };
                    }
                    cityCenters[city].lat += center.lat;
                    cityCenters[city].count++;

                    // å­˜å„²é„‰é®å€ä¸­å¿ƒé»
                    if (!districtCenters[city]) districtCenters[city] = {};
                    districtCenters[city][district] = center.lat;
                }
            });

            // è¨ˆç®—ç¸£å¸‚å¹³å‡ç·¯åº¦
            for (let city in cityCenters) {
                cityCenters[city].avgLat = cityCenters[city].lat / cityCenters[city].count;
            }

            // æŒ‰ç¸£å¸‚ç·¯åº¦ï¼ˆç”±åŒ—åˆ°å—ï¼Œç·¯åº¦ç”±é«˜åˆ°ä½ï¼‰æ’åº
            const sortedCities = Object.keys(cities).sort((a, b) => {
                return cityCenters[b].avgLat - cityCenters[a].avgLat; // ç”±é«˜åˆ°ä½æ’åºï¼ˆåŒ—åˆ°å—ï¼‰
            });

            // å¡«å……ç¸£å¸‚é¸å–®
            $("#citySelect").append(`<option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>`);
            sortedCities.forEach(city => {
                $("#citySelect").append(`<option value="${city}">${city}</option>`);
            });

            // ç›£è½ç¸£å¸‚é¸æ“‡ï¼Œæ›´æ–°é„‰é®å€é¸å–®
            $("#citySelect").on("change", function () {
                const city = this.value;
                $("#districtSelect").html(`<option value="" disabled selected>è«‹é¸æ“‡é„‰é®å€</option>`);
                $("#districtSelect").prop("disabled", false);
                if (!city) return;

                // æŒ‰é„‰é®å€ç·¯åº¦ï¼ˆç”±åŒ—åˆ°å—ï¼Œç·¯åº¦ç”±é«˜åˆ°ä½ï¼‰æ’åº
                const sortedDistricts = cities[city].sort((a, b) => {
                    return districtCenters[city][b] - districtCenters[city][a]; // ç”±é«˜åˆ°ä½æ’åºï¼ˆåŒ—åˆ°å—ï¼‰
                });

                sortedDistricts.forEach(district => {
                    $("#districtSelect").append(`<option>${district}</option>`);
                });
            });
        });

        /* ç¸£å¸‚é¸æ“‡ */
        $("#districtSelect").on("change", function () {
            selectArea($("#citySelect").val(), this.value);
        });

        /* æ ¸å¿ƒï¼šé¸å–è¡Œæ”¿å€ï¼ˆåœ°åœ– / é¸å–® å…±ç”¨ï¼‰ */
        function selectArea(city, district, layerFromMap) {
            if (!city || !district) return;

            // reset
            if (selectedLayer) selectedLayer.setStyle(baseStyle);

            geoLayer.eachLayer(l => {
                const p = l.feature.properties;
                if (p.COUNTYNAME === city && p.TOWNNAME === district) {
                    selectedLayer = l;
                }
            });

            if (!selectedLayer) return;

            selectedLayer.setStyle(activeStyle);
            map.fitBounds(selectedLayer.getBounds(), { padding: [30, 30] });

            // åŒæ­¥é¸å–®
            $("#citySelect").val(city).trigger("change");
            $("#districtSelect").val(district);

            // é¡¯ç¤ºçµ±è¨ˆ
            const key = city + district;
            if (stats[key]) {
                $("#infoTitle").text(key);
                $("#pop").text(stats[key].pop.toLocaleString());
                $("#price").text(stats[key].price);
                $("#density").text(stats[key].density);
                $("#infoBox").removeClass("d-none");
            }
        }

        /* æ¸…é™¤ */
        $("#clearBtn").on("click", () => {
            if (selectedLayer) selectedLayer.setStyle(baseStyle);
            selectedLayer = null;
            $("#citySelect, #districtSelect").val("");
            $("#districtSelect").prop("disabled", true);
            $("#infoBox").addClass("d-none");
            map.setView([23.7, 121], 7);
        });
    </script>


</body>

</html>